name: ğŸš€ CI/CD Pipeline
run-name: 'Pipeline: ${{ github.ref_name }} by @${{ github.actor }}'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.x'
  WORKING_DIRECTORY: './calculadora'

jobs:
  # ==========================================
  # ğŸ” ANÃLISIS INICIAL Y PREPARACIÃ“N
  # ==========================================
  prepare:
    name: 'ğŸ” Preparation & Analysis'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.key }}
      node-modules-changed: ${{ steps.changes.outputs.dependencies }}
      source-changed: ${{ steps.changes.outputs.source }}
      tests-changed: ${{ steps.changes.outputs.tests }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            dependencies:
              - 'calculadora/package*.json'
            source:
              - 'calculadora/src/**'
            tests:
              - 'calculadora/test/**'
              - 'calculadora/src/**/*.spec.ts'

      - name: ğŸ”‘ Generate cache keys
        id: cache-keys
        run: |
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('calculadora/package-lock.json') }}" >> $GITHUB_OUTPUT

  # ==========================================
  # ğŸ“¦ INSTALACIÃ“N DE DEPENDENCIAS
  # ==========================================
  dependencies:
    name: 'ğŸ“¦ Dependencies'
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 8
    if: needs.prepare.outputs.node-modules-changed == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'calculadora/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          
      - name: ğŸ’¾ Cache node_modules
        uses: actions/cache@v4
        with:
          path: calculadora/node_modules
          key: ${{ needs.prepare.outputs.cache-key }}

  # ==========================================
  # ğŸ” CALIDAD DE CÃ“DIGO
  # ==========================================
  quality:
    name: 'ğŸ” Code Quality'
    runs-on: ubuntu-latest
    needs: [prepare, dependencies]
    timeout-minutes: 6
    if: always() && !cancelled() && (needs.dependencies.result == 'success' || needs.dependencies.result == 'skipped')
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'calculadora/package-lock.json'

      - name: ğŸ”„ Restore dependencies
        uses: actions/cache@v4
        with:
          path: calculadora/node_modules
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: ğŸ“¦ Install if cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ” ESLint
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm run lint -- --cache --cache-location=".eslintcache" --format=compact

      - name: ğŸ¨ Prettier
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npx prettier --check "src/**/*.ts" "test/**/*.ts" --cache

      - name: ğŸ“ TypeScript
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npx tsc --noEmit

  # ==========================================
  # ğŸ—ï¸ BUILD
  # ==========================================
  build:
    name: 'ğŸ—ï¸ Build'
    runs-on: ubuntu-latest
    needs: [prepare, dependencies, quality]
    timeout-minutes: 8
    if: always() && !cancelled() && needs.quality.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”„ Restore dependencies
        uses: actions/cache@v4
        with:
          path: calculadora/node_modules
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: ğŸ“¦ Install if cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ—ï¸ Build application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm run build
          
      - name: ğŸ“Š Build analysis
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "=== Build Output Analysis ==="
          du -sh dist/
          find dist -name "*.js" | wc -l
          echo "=== Largest files ==="
          find dist -name "*.js" -exec ls -lh {} + | sort -k5 -hr | head -5

      - name: ğŸ’¾ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            calculadora/dist
          key: build-${{ runner.os }}-${{ github.sha }}

  # ==========================================
  # ğŸ§ª TESTS
  # ==========================================
  test:
    name: 'ğŸ§ª Tests (Node ${{ matrix.node-version }})'
    runs-on: ubuntu-latest
    needs: [prepare, dependencies]
    timeout-minutes: 12
    if: always() && !cancelled() && (needs.dependencies.result == 'success' || needs.dependencies.result == 'skipped') && inputs.skip_tests != true
    
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.x, 22.x]
        test-type: [unit, e2e]
        
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ”„ Restore dependencies
        uses: actions/cache@v4
        with:
          path: calculadora/node_modules
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: ğŸ“¦ Install if cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§ª Run unit tests
        if: matrix.test-type == 'unit'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm run test -- --coverage --watchAll=false --testTimeout=10000 --maxWorkers=2
        env:
          NODE_ENV: test

      - name: ğŸ§ª Run e2e tests
        if: matrix.test-type == 'e2e'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm run test:e2e -- --testTimeout=30000 --maxWorkers=1
        env:
          NODE_ENV: test

      - name: ğŸ“Š Upload coverage
        if: matrix.test-type == 'unit' && matrix.node-version == '22.x'
        uses: codecov/codecov-action@v5
        with:
          file: ./calculadora/coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  # ==========================================
  # ğŸ¯ RESULTADO FINAL
  # ==========================================
  result:
    name: 'ğŸ¯ Pipeline Result'
    runs-on: ubuntu-latest
    needs: [prepare, quality, build, test]
    if: always() && !cancelled()
    timeout-minutes: 2
    
    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "## ğŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Success
        if: needs.quality.result == 'success' && needs.build.result == 'success' && (needs.test.result == 'success' || inputs.skip_tests == true)
        run: |
          echo "ğŸ‰ Â¡Pipeline ejecutado exitosamente!"
          echo "âœ… Calidad de cÃ³digo: PASSED"
          echo "âœ… Build: PASSED" 
          echo "âœ… Tests: ${{ inputs.skip_tests == true && 'SKIPPED' || 'PASSED' }}"

      - name: âŒ Failure
        if: needs.quality.result == 'failure' || needs.build.result == 'failure' || needs.test.result == 'failure'
        run: |
          echo "âŒ Pipeline fallÃ³ - revisa los logs para mÃ¡s detalles"
          exit 1